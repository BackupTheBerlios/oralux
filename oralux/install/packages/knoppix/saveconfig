#!/bin/bash
# saveconfig - create KNOPPIX configuration floppy
# (C) Klaus Knopper Mar 2002
# Spanish translation by Luis Llorente, luis.llorente@hispalinux.es
#
# Changes for Oralux
# Sep 2003: 
# German translations by Guenther Harrasser.
# Spanish translations by Fernando Pinto da Silva.
#
# 2003, 2004 Gilles Casse
# * French translation
# * The new config is compared to the old one (via their md5sum)
# * /etc/fstab is not stored
# * If the (basic) configuration files are saved to the boot floppy, 
#   cheatcode floppyconfig is added in syslinux.cfg instead of myconf=...
# * knoppix.sh: once the files are restored, it installs the symbolic links (/etc/sysconfig/symlinks)
#
#set -v 
export DIALOG="/usr/bin/php5 /usr/share/oralux/dialog/dialog.php"

PATH="/bin:/sbin:/usr/bin:/usr/sbin"
export PATH

# Get root
[ "`id -u`" != "0" ] && exec sudo "$0" "$@"

newList=`tempfile 2>/dev/null`
TMP=`tempfile 2>/dev/null`

bailout(){
rm -f "$newList" "$TMP" "$TMP.err" "/tmp/configs.tbz"
exit 0
}

trap bailout 1 2 3 15

FLOPPYDIR="$(ls -l /mnt/floppy | awk '{print $NF}')"

umountfloppy(){
#mount | grep -q "$FLOPPYDIR" && umount "$FLOPPYDIR" 2>/dev/null
mount | grep -q "$FLOPPYDIR" && umount "$FLOPPYDIR" 2>/dev/null
}

# Try to mount this filesystem read-only
trymount(){
# Check if already mounted
case "$(cat /proc/mounts)" in *\ $2\ *) return 0;; esac
# Apparently, mount-aes DOES autodetect AES loopback files.
[ -b "$1" ] && { mount -t auto -o ro "$1" "$2" 2>/dev/null; RC="$?"; }
# We need to mount crypto-loop files with initial rw support
[ -f "$1" ] && { mount -t auto -o loop,rw "$1" "$2" 2>/dev/null; RC="$?"; }
# Mount succeeded?
[ "$RC" = "0" ] && return 0
return 1
}

findchanged(){
if [ -d "$1" ]; then
for i in `( cd "$1"; find . -type f | sed 's,^\./,,g' | grep -v ' ' | grep -v "~$" )`; do
cmp -s "$1/$i" "$2/$i" || echo "$1/$i"

done
elif [ -e "$1" ]; then
cmp -s "$1" "$2" || echo "$1"
fi
}

getNewList(){

    if [ "$1" == "SAVEHOME" ]; then
	IGNORE="\.ICEauthority|ksycoka|\.xsession-errors|\.DCOP|\.MCOP|kio_http/cache|\.mozilla/.*/Cache/|favicons|office/user/work"
	for i in $HOME/.??* $HOME/office $HOME/evolution; do findchanged "$i" /etc/skel/$(basename "$i"); done | egrep -v -e '('"$IGNORE"')' > "$newList"
    fi

#    SAVEDESK=""
#    [ -n "$SAVEDESK" ] && for i in $HOME/Desktop; do findchanged "$i" /etc/skel/$(basename "$i"); done >> "$newList"
    
    IGNORE='/etc/ioctl.save|/etc/fstab|/etc/mtab|/etc/X11/XF86Config-4|/etc/X11/XF86Config'
    if [ -d /KNOPPIX/etc ]; then
	findchanged /etc /KNOPPIX/etc | egrep -v -e '('"$IGNORE"')' >>"$newList"
    fi
}

# getOldList(){
#     source /etc/sysconfig/knoppix
#
#     MYCONFDEVICE=/dev/sda1
#     MYCONFMOUNTPOINT=/mnt/sda1
#     MYCONFDIR=/mnt/sda1

#     if [ -n "$MYCONFDEVICE" ]; then
# 	if trymount "$MYCONFDEVICE" "$MYCONFMOUNTPOINT"; then
# 	    MYCONFIG="$(ls -1d $MYCONFDIR/[Cc][Oo][Nn][Ff][Ii][Gg][Ss].[Tt][Bb][Zz] 2>/dev/null)"
# 	    if [ -n "$MYCONFIG" -a -f "$MYCONFIG" ]; then
# 		tar -jpPtf "$MYCONFIG" > $oldList
# 	    fi
# 	fi
#     fi
# }

writescript(){
CONFIGSFILE=$2
cat >"$1" <<EOT
#!/bin/sh
[ "\`id -u\`" = "0" ] || { echo "You need root privileges to modify the system!" >&2 ; exit 1; }
[ -d "\$1" ] && CONFIGS="\$1/configs.tbz"
[ -f "\$CONFIGS" ] || CONFIGS="/cdrom/KNOPPIX/configs.tbz"
[ -f "\$CONFIGS" ] || CONFIGS="/mnt/floppy/configs.tbz"
if [ -f "\$CONFIGS" ]; then
echo "Extracting config archive \$CONFIGS..."
tar -jpPtf "\$CONFIGS" | while read i; do rm -f "\$i"; done
tar -jpPxf "\$CONFIGS" ; $CHOWNHOME
fi

# Restoring the symlinks
symlinksfile="/etc/sysconfig/symlinks"
if [ -e "\$symlinksfile" ]; then
bash "\$symlinksfile" 
fi

EOT

SCRIPTS=""
STARTNET=""
STARTPCMCIA=""
STARTCUPS=""
REINIT=""

while read i; do
case "$i" in
/etc/network/interfaces) STARTNET="yes";;
/etc/pcmcia/*) STARTPCMCIA="yes";;
/etc/cups*) STARTCUPS="yes";;
/etc/inittab) REINIT="yes";;
esac
done <"$newList"

[ -n "$STARTNET" ] && { echo "killall pump 2>/dev/null && sleep 2 && killall -9 pump 2>/dev/null && sleep 2" >>"$KNOPPIXSH" ; SCRIPTS="$SCRIPTS ifupdown networking"; }
[ -n "$STARTPCMCIA" ] && echo 'echo "(Re)starting PCMCIA services."; killall cardmgr 2>/dev/null && sleep 4; cardmgr && sleep 4' >>"$KNOPPIXSH"
[ -n "$STARTCUPS" ] && SCRIPTS="$SCRIPTS cupsys"

if [ -n "$SCRIPTS" ]; then
echo 'echo "Starting daemons..."' >>"$KNOPPIXSH"
echo "for i in $SCRIPTS; do [ -x /etc/init.d/\$i ] && /etc/init.d/\$i start; done" >>"$KNOPPIXSH"
fi

[ -n "$REINIT" ] && echo 'echo "Reloading INIT." ; init q' >> "$KNOPPIXSH"

rm -f "$TMP.err"
#BZIP2=-9 tar -T - -cpPjf "$DIRECTORY/configs.tbz" <"$newList" 2>"$TMP.err"

cp "$CONFIGSFILE" "$DIRECTORY/configs.tbz"

RC="$?"

if [ "$DIRECTORY" = "$FLOPPYDIR" ]; then

if [ -e "$DIRECTORY/syslinux.cfg" ]; then
# We use the floppyconfig cheatcode
sed "s;[^ ]*conf[^=]*=[^ ]*/[^ ]*;floppyconfig;g" "$DIRECTORY/syslinux.cfg" > $TMP
mv -f $TMP "$DIRECTORY/syslinux.cfg" 2>/dev/null
fi

umountfloppy
else 
# Not saved on floppy
umount "$DIRECTORY" 2>/dev/null

# RAF (GC): if there is a boot floppy, force the cheatcode to myconf=scan
# sed "s;floppyconf[^ ]*;myconf=scan;g"

fi
}

saveNewList(){
CONFIGS_FILE=$1

MESSAGE4="Bitte wählen Sie das Verzeichnis, in das Sie die Konfigurationsdateien schreiben wollen."
MESSAGE4="Seleccione el directorio para guardar los archivos de configuración."
MESSAGE4="Choisissez, s'il vous plait, le répertoire de sauvegarde des fichiers de configuration :"    
MESSAGE4="Please select directory for saving configuration files:"

# Directory selector
PARTITIONS="/mnt/floppy [Floppy] on"
for i in `awk '/^\/dev\/[hs]d[a-z].*\/mnt\/[hs]d[a-z]/{if(!/ntfs/){print $2}}' /etc/fstab`
do
PARTITIONS="$PARTITIONS ${i} [Disk/Partition] off"
done

rm -f "$TMP"
$DIALOG --clear --radiolist "$MESSAGE4" 18 75 9 $PARTITIONS 2>"$TMP" || bailout

DIRECTORY=`cat $TMP`

[ -z "$DIRECTORY" -o ! -e "$DIRECTORY" ] && bailout

case "$DIRECTORY" in *floppy*)
DIRECTORY="$FLOPPYDIR"
KNOPPIXSH="$DIRECTORY/knoppix.sh"
while :; do
umountfloppy

MESSAGE2="Bitte legen Sie jetzt eine leere DOS- oder ext2-formatierte, schreibbare Diskette ein."
MESSAGE2="Inserte un disquete vacío formateado para DOS o ext2."
MESSAGE2="Insérez s'il vous plait une disquette déjà formattée DOS ou ext2, et inscriptible."
MESSAGE2="Please insert an empty DOS- or ext2-formatted, writable floppy disk."

$DIALOG --msgbox "$MESSAGE2" 16 51 2 || bailout

echo "$FLOPPYDIR" | grep -q auto || mount /mnt/floppy
[ "$?" = "0" ] && writescript "$KNOPPIXSH" "$CONFIGS_FILE" && break
done
;;
*)
ERROR="Leider konnte die KNOPPIX-Konfiguration NICHT gespeichert werden:"
ERROR="No se pudo guardar la configuración de KNOPPIX:"
ERROR="La configuration KNOPPIX n'a pu être sauvée :"
ERROR="The KNOPPIX configuration could NOT be saved:"
rm -f "$TMP.err"
mount | grep -q "$DIRECTORY" || mount -r "$DIRECTORY" >"$TMP.err"
[ "$?" != "0" ] && { $DIALOG --msgbox "$ERROR `cat $TMP.err`" 10 75; bailout; }
mount | grep -q "$DIRECTORY.*ntfs" && { $DIALOG --title "$TITLE1" --msgbox "$ERROR NTFS" 10 75; bailout; }
mount -o remount,rw "$DIRECTORY"
KNOPPIXSH="$DIRECTORY/knoppix.sh"
writescript "$KNOPPIXSH" "$CONFIGS_FILE"
esac
}

MESSAGE1="Wollen Sie Konfigurationsdateien speichern:"
MESSAGE1="¿Desea guardar los archivos de configuración ?"
MESSAGE1="Souhaitez-vous sauvegarder les fichiers de configuration ?"
MESSAGE1="Do you want to save the configuration files?"

$DIALOG --yesno "$MESSAGE1" 8 65 || bailout

# Compare the new list of configuration files and the previous one 

SAVEHOME=""
if [ "/home/knoppix" == "$(find /home/knoppix -maxdepth 0 -fstype tmpfs)" ]
then
    SAVEHOME="SAVEHOME"
fi

getNewList $SAVEHOME

rm -f "$TMP.err"
BZIP2=-9 tar -T - -cpPjf "/tmp/configs.tbz" <"$newList" 2>"$TMP.err"
newSum=$(md5sum /tmp/configs.tbz | awk '{printf $1}' )

source /etc/sysconfig/knoppix
if [ "$newSum" != "$CONFIGMD5" ]; then
    saveNewList "/tmp/configs.tbz"
fi

bailout
